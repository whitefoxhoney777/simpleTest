<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8">
    <title>WebView Keyboard & BottomSheet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <style>
      html, body {
        margin:0; padding:0; height:100%; font-family:Arial, Helvetica, sans-serif; overflow:hidden;
      }
      .content {height:100%; overflow-y:auto; padding:16px; box-sizing:border-box;}
      .bottom-sheet {
        position:fixed;
        left:0;
        right:0;
        bottom:0;
        box-sizing:border-box;
        height:200px;
        background:#fff;
        border-top:1px solid #ddd;
        box-shadow:0 -2px 8px rgba(0,0,0,.1);
        /* transform 기반으로 이동: bottom은 항상 0 유지 */
        transform: translateY(0);
        transition: transform .18s ease-out;
        will-change: transform;
        padding:12px;
      }
      .bottom-sheet h3 {margin:0 0 8px;}
      .bottom-sheet button {padding:8px 12px; font-size:14px;}
    </style>
  </head>
  <body>
    <div class="content">
      <h2>키보드 감지 테스트</h2>
      <p>아래 입력창을 탭하면 키보드가 뜨고, 바텀시트가 위로 이동합니다.</p>
      <textarea rows="4" style="width:100%;font-size:16px;" placeholder="여기에 입력해 보세요..."></textarea>
      <p>스크롤 필요시 내용을 늘려주세요.</p>
      <div style="height:800px"></div>
    </div>

    <div class="bottom-sheet">
      <h3>바텀시트</h3>
      <button type="button" onclick="alert('버튼 클릭')">버튼</button>
    </div>

    <script>
      (() => {
        const bottomSheet = document.querySelector('.bottom-sheet');

        // 초기 뷰포트 높이(키보드 없는 상태 기준)
        let baseHeight = window.visualViewport ? window.visualViewport.height : window.innerHeight;
        let keyboardOpen = false;
        let currentKeyboardHeight = 0;
        const KEYBOARD_THRESHOLD = 100; // px

        const getVisibleHeight = () => window.visualViewport ? window.visualViewport.height : window.innerHeight;

        const onResize = () => {
          const visibleHeight = getVisibleHeight();
          // 음수 방지: baseHeight - visibleHeight
          let keyboardHeight = Math.max(0, baseHeight - visibleHeight);

          // 키보드 열림 판단
          if (keyboardHeight > KEYBOARD_THRESHOLD) {
            // cap: 바텀시트가 화면 상단을 넘지 않도록 제한
            const sheetH = bottomSheet.offsetHeight || 200;
            // 허용 가능한 최대 이동량 = visibleHeight - sheetH - margin
            const marginTop = 10; // 상단과의 최소 간격
            const maxAllowedTranslate = Math.max(0, visibleHeight - sheetH - marginTop);
            const translateY = Math.min(keyboardHeight, maxAllowedTranslate);

            // 적용
            bottomSheet.style.transform = `translateY(-${translateY}px)`;
            bottomSheet.style.bottom = '0px'; // 항상 0
            keyboardOpen = true;
            currentKeyboardHeight = keyboardHeight;
          } else {
            // 키보드 닫힘: 리셋
            bottomSheet.style.transform = 'translateY(0)';
            bottomSheet.style.bottom = '0px';
            if (keyboardOpen) {
              // 키보드가 막 닫혔다면 base 기준을 갱신 (회전 등 대응)
              baseHeight = visibleHeight;
            } else {
              // 일반 리사이즈(예: 회전)일 때도 기준 갱신
              baseHeight = visibleHeight;
            }
            keyboardOpen = false;
            currentKeyboardHeight = 0;
          }
        };

        // 이벤트 바인딩
        window.addEventListener('resize', onResize);
        if (window.visualViewport) {
          window.visualViewport.addEventListener('resize', onResize);
          window.visualViewport.addEventListener('scroll', onResize);
        }

        // 초기 실행
        onResize();

        // focus 보정: 입력창이 키보드/바텀시트에 가려지지 않도록 스크롤
        document.addEventListener('focusin', (e) => {
          const target = e.target;
          if (!target) return;
          const tag = target.tagName ? target.tagName.toUpperCase() : '';
          if (tag === 'INPUT' || tag === 'TEXTAREA') {
            const visibleHeight = getVisibleHeight();
            const kbHeight = currentKeyboardHeight;
            const rect = target.getBoundingClientRect();
            const visibleBottom = visibleHeight - kbHeight;
            const offset = rect.bottom - visibleBottom;
            if (offset > 0) {
              window.scrollBy({ top: offset + 20, behavior: 'smooth' });
            }
          }
        });
      })();
    </script>
  </body>
</html>
