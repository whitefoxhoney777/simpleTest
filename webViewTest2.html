<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8">
    <title>WebView Keyboard & BottomSheet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <style>
      /* 전체 뷰포트 고정, 가로 스크롤 방지 */
      html, body {
        margin:0;
        padding:0;
        height:100%;
        font-family:Arial, Helvetica, sans-serif;
        overflow-x:hidden; /* 가로로 넘치는 현상 방지 */
        -webkit-text-size-adjust:100%;
      }

      /* 콘텐츠는 뷰포트 만큼 최소 높이를 가지며 문서 스크롤을 사용 */
      .content {
        box-sizing:border-box;
        padding:16px;
        min-height:100vh; /* 최소 화면 전체 높이 확보 */
        /* 바텀시트 높이(200) + 여유(20)를 padding-bottom으로 확보하여 바텀시트가 콘텐츠를 가리지 않도록 함 */
        padding-bottom: 240px;
        max-width:100vw; /* 가로로 넘치지 않게 */
      }

      .bottom-sheet {
        position:fixed;
        left:0;
        right:0;
        bottom:0;
        box-sizing:border-box;
        height:200px;
        background:#fff;
        border-top:1px solid #ddd;
        box-shadow:0 -2px 8px rgba(0,0,0,.1);
        /* transform 기반으로 이동: bottom은 항상 0 유지 */
        transform: translateY(0);
        transition: transform .18s ease-out;
        will-change: transform;
        padding:12px;
        max-width:100vw; /* landscape에서 뷰포트 밖으로 넘치지 않도록 */
        overflow:hidden;
      }
      .bottom-sheet h3 {margin:0 0 8px;}
      .bottom-sheet button {padding:8px 12px; font-size:14px;}

      /* 입력 UI가 landscape에서도 너무 커지지 않게 */
      textarea, input {
        max-width:100%;
        box-sizing:border-box;
      }
    </style>
  </head>
  <body>
    <div class="content">
      <h2>키보드 감지 테스트</h2>
      <p>아래 입력창을 탭하면 키보드가 뜨고, 바텀시트가 위로 이동합니다.</p>
      <textarea rows="4" style="width:100%;font-size:16px;" placeholder="여기에 입력해 보세요..."></textarea>
      <p>스크롤 필요시 내용을 늘려주세요.</p>
      <div style="height:800px"></div>
    </div>

    <div class="bottom-sheet" aria-hidden="false">
      <h3>바텀시트</h3>
      <button type="button" onclick="alert('버튼 클릭')">버튼</button>
    </div>

    <script>
      (function () {
        const bottomSheet = document.querySelector('.bottom-sheet');
        const content = document.querySelector('.content');
        const KEYBOARD_THRESHOLD = 100; // px: 이 값보다 크면 '키보드 열림'으로 판단
        let keyboardOpen = false;
        let currentKeyboardHeight = 0;

        // visualViewport 기반으로 더 정확하게 '가려진 하단 높이'를 계산
        function computeViewportInfo() {
          const layoutHeight = document.documentElement.clientHeight || window.innerHeight;
          if (window.visualViewport) {
            const vv = window.visualViewport;
            const visibleTop = vv.offsetTop || 0;
            const visibleHeight = vv.height;
            // layoutHeight - (visibleTop + visibleHeight) = 화면 하단에서 보이지 않는 영역(=키보드 등)
            const hiddenBottom = Math.max(0, Math.round(layoutHeight - visibleTop - visibleHeight));
            return { layoutHeight, visibleTop, visibleHeight, hiddenBottom };
          } else {
            // visualViewport 미지원 브라우저에서는 hiddenBottom 계산이 불안정하므로 0으로 처리
            return { layoutHeight, visibleTop:0, visibleHeight: layoutHeight, hiddenBottom: 0 };
          }
        }

        function onViewportChange() {
          const info = computeViewportInfo();
          const keyboardHeight = info.hiddenBottom;

          if (keyboardHeight > KEYBOARD_THRESHOLD) {
            // 키보드 열린 상태
            const sheetH = bottomSheet.offsetHeight || 200;
            const visibleHeight = info.visibleHeight;
            // 바텀시트가 화면 상단을 넘지 않도록 허용 가능한 최대 이동량
            const marginTop = 10;
            const maxAllowedTranslate = Math.max(0, visibleHeight - sheetH - marginTop);
            const translateY = Math.min(keyboardHeight, maxAllowedTranslate);

            bottomSheet.style.transform = `translateY(-${translateY}px)`;
            bottomSheet.style.bottom = '0px';
            keyboardOpen = true;
            currentKeyboardHeight = keyboardHeight;
          } else {
            // 키보드 닫힘 또는 무시할 정도의 리사이즈
            bottomSheet.style.transform = 'translateY(0)';
            bottomSheet.style.bottom = '0px';
            keyboardOpen = false;
            currentKeyboardHeight = 0;
          }
        }

        // 스크롤 보정: 포커스된 입력이 키보드/바텀시트에 가려지지 않도록 스크롤
        function ensureFocusedVisible(target) {
          if (!target) return;
          const tag = target.tagName ? target.tagName.toUpperCase() : '';
          if (tag !== 'INPUT' && tag !== 'TEXTAREA') return;

          const info = computeViewportInfo();
          const visibleHeight = info.visibleHeight;
          const kbHeight = currentKeyboardHeight;
          const rect = target.getBoundingClientRect();
          const visibleBottom = visibleHeight - kbHeight;
          const offset = rect.bottom - visibleBottom;

          if (offset > 0) {
            // 가능한 경우 .content 자체를 스크롤(내부 스크롤이 있는 경우) 아니면 window를 스크롤
            const scrollContainer = content;
            if (scrollContainer && scrollContainer.scrollHeight > scrollContainer.clientHeight) {
              scrollContainer.scrollBy({ top: offset + 20, behavior: 'smooth' });
            } else {
              window.scrollBy({ top: offset + 20, behavior: 'smooth' });
            }
          }
        }

        // 이벤트 바인딩
        window.addEventListener('resize', onViewportChange);
        if (window.visualViewport) {
          window.visualViewport.addEventListener('resize', onViewportChange);
          window.visualViewport.addEventListener('scroll', onViewportChange);
        }

        // focus 보정
        document.addEventListener('focusin', (e) => {
          // 약간의 딜레이를 줘서 visualViewport가 변경되는 시간을 기다림
          setTimeout(() => ensureFocusedVisible(e.target), 50);
        });

        // 초기 실행
        onViewportChange();
      })();
    </script>
  </body>
</html>
