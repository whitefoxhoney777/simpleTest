<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8">
    <title>WebView Keyboard & BottomSheet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <style>
      html, body {
        margin:0; padding:0; height:100%; font-family:Arial, Helvetica, sans-serif; overflow:hidden; /* 스크롤은 WebView 내부가 담당 */
      }
      .content {height:100%; overflow-y:auto; /* 내용 길면 스크롤 발생 */padding:16px; box-sizing:border-box;}
      .bottom-sheet {position:fixed; left:0; right:0; bottom:0; box-sizing:border-box; 
                     height:200px; /* 원하는 높이 기입: 키보드가 없을 때는 기능 */ 
                     background:#fff; border-top:1px solid #ddd; box-shadow:0 -2px 8px rgba(0,0,0,.1);
                     transition:bottom .2s ease-out; padding:12px;}
      .bottom-sheet h3 {margin:0 0 8px;}
      .bottom-sheet button {padding:8px 12px; font-size:14px;}
    </style>
  </head>
  <body>
    <div class="content">
      <h2>키보드 감지 테스트</h2>
      <p>아래 입력창을 탭하면 키보드가 뜨고, 바텀시트가 위로 이동합니다.</p>
      <textarea rows="4" style="width:100%;font-size:16px;" placeholder="여기에 입력해 보세요..."></textarea>
      <p>스크롤 필요시 내용을 늘려주세요.</p>
      <div style="height:800px"></div>
    </div>

    <div class="bottom-sheet">
      <h3>바텀시트</h3>
      <button type="button" onclick="alert('버튼 클릭')">버튼</button>
    </div>

    <script>
      (() => {
        const bottomSheet = document.querySelector('.bottom-sheet');
        
        // 최초 로드 시의 뷰포트 높이 저장: 키보드가 없는 상태
        let baseHeight = window.innerHeight; // fallback
        if (window.visualViewport) {
          baseHeight = window.visualViewport.height; // ios Safari 등에서 더 정확
        }

        // 현재 키보드가 열려 있는지 판단하는 플래그
        let keyboardOpen = false;

        // 뷰포트 높이 변화 감지 (모든 플랫폼에서 동작)
        const onResize = () => {
          const onResize = () => {
            const curHeight = window.visualViewport ? window.visualViewport.height : window.innerHeight;
            const diff = baseHeight - curHeight; // 양수면 키보드가 올라온 경우

            // 차이가 100px 이상이면 "키보드가 열렸다"라고 판단 (임계값은 상황에 맞게 조정)
            if(diff > 100) {
              // 키보드 열림
              if (!keyboardOpen) {
                keyboardOpen = true;
                bottomSheet.style.bottom = diff + 'px'; // 바텀시트를 키보드 위에 배치
              }
            } else {
              // 키보드 닫힘
              if(keyboardOpen) {
                keyboardOpen = false;
                bottomSheet.style.bottom = '0px';
            }
          }
        };

        // 1. resize 이벤트 (Android Chrome, iOS Chrome 등)
        window.addEventListener('resize', onResize');
          
        // 2. visualViewport 이벤트 (iOS Safari, 최신 Chrome 등)
        if(window.visualViewport) {
          window.visualViewport.addEventListener('resize', onResize);
          window.visualViewport.addEventListener('scroll', onResize); // 스크롤 시에도 재계산
        }

        // 페이지 로드 직후 한 번 호출해 초기값을 확정
        onResize();

        // --- 선택 사항: 입력창 포커스 시 자동 스크롤 => 입력창이 바텀시트 위에 가려지지 않도록 스크롤 보정
        document.addEventListener('focusin', (e) => {
          if(e.target.tagName = 'INPUT' || e.target.tagName = 'TEXTAREA') {
            // 현재 스크롤 위치 + 입력창 위치를 고려해 부드럽게 스크롤
            const rect = e.target.getBoundingClentRect();
            const offset = rect.bottom - (window.innerHeight - (keyboardOpen ? diff : 0));
            if(offset > 0) {
              window.scrollBy{top:offset + 20, behavior: 'smooth'});
            }
          }
        });
      })();
    </script>
  </body>
</html>
